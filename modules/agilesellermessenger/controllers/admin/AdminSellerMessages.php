<?php
///-build_id: 2019051707.2854
/// This source file is subject to the Software License Agreement that is bundled with this 
/// package in the file license.txt, or you can get it here
/// http://addons-modules.com/en/content/3-terms-and-conditions-of-use
///
/// @copyright  2009-2016 Addons-Modules.com
///  If you need open code to customize or merge code with othe modules, please contact us.
include_once(_PS_ROOT_DIR_ . '/modules/agilesellermessenger/AgileSellerMessage.php');
include_once(_PS_ROOT_DIR_ . '/modules/agilesellermessenger/agilesellermessenger.php');

class AdminSellerMessagesController extends ModuleAdminController
{    
	public function __construct()   {    $this->bootstrap = true;   $this->table = 'agile_sellermessage';     $this->className = 'AgileSellerMessage';      parent::__construct();      if(!$this->is_seller)    {     $this->addRowAction('delete');     $this->addRowAction('edit');    }    $this->addRowAction('view');       $this->_join = '         LEFT JOIN ' . _DB_PREFIX_ . 'product_lang pl ON a.id_product=pl.id_product AND pl.id_lang=' . $this->context->cookie->id_lang . '         LEFT JOIN ' . _DB_PREFIX_ . 'sellerinfo s ON a.id_seller=s.id_seller         LEFT JOIN ' . _DB_PREFIX_ . 'sellerinfo_lang sl ON (sl.id_sellerinfo=s.id_sellerinfo AND sl.id_lang=' . intval($this->context->cookie->id_lang). ')         LEFT JOIN ' . _DB_PREFIX_ . 'employee e ON a.id_seller=e.id_employee     ';         $this->_select = ' pl.name AS product, sl.company as seller';      if($this->is_seller)    {        $this->_where = $this->_where . ' AND a.id_seller=' . intval($this->context->cookie->id_employee) ;          }      $this->fields_list = array(        'id_agile_sellermessage' => array('title' => $this->l('ID'), 'align' => 'center', 'width' => 25),     'date_add' => array('title' => $this->l('Date'),'type'=>'datetime', 'align' => 'center', 'width' => 25,'filter_key'=>'a!date_add'),     'active' => array('title' => $this->l('Approved'), 'align' => 'center', 'width' => 25,'active'=> 'status','filter_key'=>'a!active'),        'from_name' => array('title' => $this->l('From Name'), 'align' => 'left', 'width' => 120),     'product' => array('title' => $this->l('Product Name'), 'align' => 'left', 'width' => 150,'tmpTableFilter' => true),     'message' => array('title' => $this->l('Message'),  'align' => 'left', 'width' => 250)    );      if(!$this->is_seller)    {     $this->fields_list['seller'] = array('title' => $this->l('Seller'), 'width' => 60, 'tmpTableFilter' => true);                  }                   $REA328ABCD9DBE025C576B345EA4AED5C = intval(Configuration::get('ASMGER_HIDE_EMAIL'));          if(!$REA328ABCD9DBE025C576B345EA4AED5C OR !$this->is_seller)           {        $this->fields_list['from_email'] = array('title' => $this->l('From Email'), 'align' => 'left', 'width' => 120);          }       }      public function viewAccess($R27452AB399682DBEAADE702EE7FBCAE8 = false)   {    $R96E173F8ACE6F851F6CAA82BD919D234 = new AgileSellerMessage((int)Tools::getValue("id_agile_sellermessage"));    if($R96E173F8ACE6F851F6CAA82BD919D234->id_product > 0 && $this->is_seller)    {     $R05A7FD59CA6FB50AC648A5447FEADD4A = AgileSellerManager::getObjectOwnerId("product", $R96E173F8ACE6F851F6CAA82BD919D234->id_product);     if($R05A7FD59CA6FB50AC648A5447FEADD4A >0 && $R05A7FD59CA6FB50AC648A5447FEADD4A == $this->context->cookie->id_employee)return true;    }    return parent::viewAccess($R27452AB399682DBEAADE702EE7FBCAE8);   }      public function initToolbar()   {    parent::initToolbar();    unset($this->toolbar_btn['new']);   }         public function display()   {    if (isset($_GET['filename']))     AgileSellerMessenger::openUploadedFile($_GET['id_seller'],  $_GET['filename']);    else    {     parent::display();    }   }         public function postProcess()   {      if (Tools::isSubmit('submitReply'))    {        $R6F82286AF8E7368B69D53D2BFC9EECFA = Tools::getValue('reply_message');              if(empty($R6F82286AF8E7368B69D53D2BFC9EECFA))              {                  $this->_errors[] = $this->l('Reply message cannot be empty.');                  return;              }              $R2065A4598F5AC52A855CD972A4D582B5 = new AgileSellerMessage(Tools::getValue('id_agile_sellermessage'));              $R95909C49377A2B4F24C79D29C629AF65 = intval($R2065A4598F5AC52A855CD972A4D582B5->id_seller);              if($R95909C49377A2B4F24C79D29C629AF65<=0)$R95909C49377A2B4F24C79D29C629AF65 = 1;              $R17AC9BFA1ABB066C772CEAE0B3CD86E9 = new Employee(($R95909C49377A2B4F24C79D29C629AF65 > 0 ? $R95909C49377A2B4F24C79D29C629AF65 : 1));                   $REA328ABCD9DBE025C576B345EA4AED5C = intval(Configuration::get('ASMGER_HIDE_EMAIL'));     $R996A912949D42940B4C679CD4A1A2A73 = Configuration::get('PS_SHOP_EMAIL');     if($REA328ABCD9DBE025C576B345EA4AED5C)         $R39A530506329CA296814791255B22F17 = NULL;     else         $R39A530506329CA296814791255B22F17 = $R157A6826A8BF1F36EBBE3DEC02351744->from_email;                $R6F82286AF8E7368B69D53D2BFC9EECFA .= "\n";                         $R3870A31671674F38BD563DC916D3A5A0 = explode("\n", $R2065A4598F5AC52A855CD972A4D582B5->message);           foreach($R3870A31671674F38BD563DC916D3A5A0 AS $R9061C9FEF16E7C8C556365E17D37952C)           {               $R6F82286AF8E7368B69D53D2BFC9EECFA .= ">" . $R9061C9FEF16E7C8C556365E17D37952C . "\n";           }        if((int)Configuration::get('ASMGER_REMOVE_PHONE'))$R6F82286AF8E7368B69D53D2BFC9EECFA = AgileHelper::remove_phone($R6F82286AF8E7368B69D53D2BFC9EECFA);     if((int)Configuration::get('ASMGER_REMOVE_EMAIL'))$R6F82286AF8E7368B69D53D2BFC9EECFA = AgileHelper::remove_email($R6F82286AF8E7368B69D53D2BFC9EECFA);             $R4180B2D55D2131557A27FB8F2D858A4F = 'mtocustomer';           $RBDB2AD8B968947A80C82ED09BD702976 = array(             '{seller_name}' => $R17AC9BFA1ABB066C772CEAE0B3CD86E9->firstname . ' ' . $R17AC9BFA1ABB066C772CEAE0B3CD86E9->lastname,             '{shop_name}' => Configuration::get('PS_SHOP_NAME'),             '{shop_url}' => Tools::getShopDomainSsl(true,true).__PS_BASE_URI__,             '{message}' => str_replace("\n","<br />", $R6F82286AF8E7368B69D53D2BFC9EECFA)           );                   $R843772E13ECF32C5CEEF23010FB27FBA = $this->context->cookie->id_lang;           $RD867D30AF2115120F58AD21C9B2F3E22 = $R2065A4598F5AC52A855CD972A4D582B5->subject;           $RDECEF4CB355A93715801928439CC147C = Language::getIsoById((int)($R843772E13ECF32C5CEEF23010FB27FBA));           if (file_exists(dirname(__FILE__).'/mails/'.$RDECEF4CB355A93715801928439CC147C.'/'.$R4180B2D55D2131557A27FB8F2D858A4F.'.txt') AND file_exists(dirname(__FILE__).'/mails/'.$RDECEF4CB355A93715801928439CC147C.'/'.$R4180B2D55D2131557A27FB8F2D858A4F.'.html'))            Mail::Send($R843772E13ECF32C5CEEF23010FB27FBA, $R4180B2D55D2131557A27FB8F2D858A4F, $RD867D30AF2115120F58AD21C9B2F3E22, $RBDB2AD8B968947A80C82ED09BD702976, $R2065A4598F5AC52A855CD972A4D582B5->from_email, NULL, $R996A912949D42940B4C679CD4A1A2A73, NULL, NULL, NULL, dirname(__FILE__).'/mails/', false, NULL,NULL,$R39A530506329CA296814791255B22F17);                               $this->confirmations[] = $this->l('Your reply message has been sent.');             if (isset($_FILES['fileUpload1']['name']) AND !empty($_FILES['fileUpload1']['name']) AND !empty($_FILES['fileUpload1']['tmp_name']))     {      $R3227A1335DA8F57625636F5E85474A1A = uniqid().substr($_FILES['fileUpload1']['name'], -5);     }     if (isset($_FILES['fileUpload2']['name']) AND !empty($_FILES['fileUpload2']['name']) AND !empty($_FILES['fileUpload2']['tmp_name']))     {      $RDA5A5C4F5E32B6177B2AD94A14775690 = uniqid().substr($_FILES['fileUpload2']['name'], -5);     }     if (isset($_FILES['fileUpload3']['name']) AND !empty($_FILES['fileUpload3']['name']) AND !empty($_FILES['fileUpload3']['tmp_name']))     {      $RC545D2EFE437137D2EFEA1053BD903CE = uniqid().substr($_FILES['fileUpload3']['name'], -5);     }          $R157A6826A8BF1F36EBBE3DEC02351744 = new AgileSellerMessage($R2065A4598F5AC52A855CD972A4D582B5->id);        $R157A6826A8BF1F36EBBE3DEC02351744->id = 0;       $R157A6826A8BF1F36EBBE3DEC02351744->is_customer_message = 0;       $R157A6826A8BF1F36EBBE3DEC02351744->ip_address = '';        $R157A6826A8BF1F36EBBE3DEC02351744->from_email = $R17AC9BFA1ABB066C772CEAE0B3CD86E9->email;        $R157A6826A8BF1F36EBBE3DEC02351744->from_name = $R17AC9BFA1ABB066C772CEAE0B3CD86E9->firstname . ' ' . $R17AC9BFA1ABB066C772CEAE0B3CD86E9->lastname;           if(intval(Configuration::get('ASMGER_APPROVAL_REQUIRED')))            $R157A6826A8BF1F36EBBE3DEC02351744->active = 0;           else            $R157A6826A8BF1F36EBBE3DEC02351744->active = 1;        $R157A6826A8BF1F36EBBE3DEC02351744->message = $R6F82286AF8E7368B69D53D2BFC9EECFA;       $R3435986BDA8C9393E0EBDB9F58F02750 = agilesellermessenger::prepareAttFolder(intval($R95909C49377A2B4F24C79D29C629AF65));     if (isset($R3227A1335DA8F57625636F5E85474A1A) AND rename($_FILES['fileUpload1']['tmp_name'], $R3435986BDA8C9393E0EBDB9F58F02750.$R3227A1335DA8F57625636F5E85474A1A))     {       $R5E49E434B525FE69B9A52B79E846320F = basename($_FILES['fileUpload1']['name']);      $R157A6826A8BF1F36EBBE3DEC02351744->attshname1 = $R5E49E434B525FE69B9A52B79E846320F;      $R157A6826A8BF1F36EBBE3DEC02351744->attpsname1 = $R3227A1335DA8F57625636F5E85474A1A;     } else     {      $R157A6826A8BF1F36EBBE3DEC02351744->attshname1 = NULL;      $R157A6826A8BF1F36EBBE3DEC02351744->attpsname1 = NULL;     }     if (isset($RDA5A5C4F5E32B6177B2AD94A14775690) AND rename($_FILES['fileUpload2']['tmp_name'], $R3435986BDA8C9393E0EBDB9F58F02750.$RDA5A5C4F5E32B6177B2AD94A14775690))     {      $R5E49E434B525FE69B9A52B79E846320F = basename($_FILES['fileUpload2']['name']);      $R157A6826A8BF1F36EBBE3DEC02351744->attshname2 = $R5E49E434B525FE69B9A52B79E846320F;      $R157A6826A8BF1F36EBBE3DEC02351744->attpsname2 = $RDA5A5C4F5E32B6177B2AD94A14775690;     } else     {      $R157A6826A8BF1F36EBBE3DEC02351744->attshname2 = NULL;      $R157A6826A8BF1F36EBBE3DEC02351744->attpsname2 = NULL;     }     if (isset($RC545D2EFE437137D2EFEA1053BD903CE) AND rename($_FILES['fileUpload3']['tmp_name'], $R3435986BDA8C9393E0EBDB9F58F02750.$RC545D2EFE437137D2EFEA1053BD903CE))     {        $R5E49E434B525FE69B9A52B79E846320F = basename($_FILES['fileUpload3']['name']);      $R157A6826A8BF1F36EBBE3DEC02351744->attshname3 = $R5E49E434B525FE69B9A52B79E846320F;      $R157A6826A8BF1F36EBBE3DEC02351744->attpsname3 = $RC545D2EFE437137D2EFEA1053BD903CE;     }else     {      $R157A6826A8BF1F36EBBE3DEC02351744->attshname3 = NULL;      $R157A6826A8BF1F36EBBE3DEC02351744->attpsname3 = NULL;     }              $R157A6826A8BF1F36EBBE3DEC02351744->save();                       return;          }            parent::postProcess();                }         public function renderView()   {    if (!($R602BAA072843820A45861C75C510C77E = $this->loadObject()))     return;      $R3435986BDA8C9393E0EBDB9F58F02750 = AgileSellerMessenger::prepareAttFolder(intval($R602BAA072843820A45861C75C510C77E->id_seller));    $R3C7F4BEFFA401E576A1962D683014AAB = "";     if(!empty($R602BAA072843820A45861C75C510C77E->attpsname1) AND file_exists($R3435986BDA8C9393E0EBDB9F58F02750.$R602BAA072843820A45861C75C510C77E->attpsname1))     $R3C7F4BEFFA401E576A1962D683014AAB .= '<a href="index.php?controller=AdminSellerMessages&id_agile_sellermessage='.$R602BAA072843820A45861C75C510C77E->id. '&viewagile_sellermessage' .'&token='.$this->token.'&filename='.$R602BAA072843820A45861C75C510C77E->attpsname1.'&id_seller='. $R602BAA072843820A45861C75C510C77E->id_seller.'" title="'.$this->l('View file').'">'. $R602BAA072843820A45861C75C510C77E->attshname1.'</a> &nbsp&nbsp';    if(!empty($R602BAA072843820A45861C75C510C77E->attpsname2) AND file_exists($R3435986BDA8C9393E0EBDB9F58F02750.$R602BAA072843820A45861C75C510C77E->attpsname2))     $R3C7F4BEFFA401E576A1962D683014AAB .= '<a href="index.php?controller=AdminSellerMessages&id_agile_sellermessage='.$R602BAA072843820A45861C75C510C77E->id. '&viewagile_sellermessage' .'&token='.$this->token.'&filename='.$R602BAA072843820A45861C75C510C77E->attpsname2.'&id_seller='. $R602BAA072843820A45861C75C510C77E->id_seller.'" title="'.$this->l('View file').'">'. $R602BAA072843820A45861C75C510C77E->attshname2.'</a> &nbsp&nbsp';    if(!empty($R602BAA072843820A45861C75C510C77E->attpsname3) AND file_exists($R3435986BDA8C9393E0EBDB9F58F02750.$R602BAA072843820A45861C75C510C77E->attpsname3))     $R3C7F4BEFFA401E576A1962D683014AAB .= '<a href="index.php?controller=AdminSellerMessages&id_agile_sellermessage='.$R602BAA072843820A45861C75C510C77E->id. '&viewagile_sellermessage' .'&token='.$this->token.'&filename='.$R602BAA072843820A45861C75C510C77E->attpsname3.'&id_seller='. $R602BAA072843820A45861C75C510C77E->id_seller.'" title="'.$this->l('View file').'">'. $R602BAA072843820A45861C75C510C77E->attshname3.'</a> &nbsp&nbsp';      $RB3F07F8C3658A835940E88288B58F707 = new Product($R602BAA072843820A45861C75C510C77E->id_product, false, $this->context->cookie->id_lang);    $R0CC5C52265050028304C711237F130C2 = Tools::getAdminToken('AdminProducts'.(int)(Tab::getIdFromClassName('AdminProducts')).(int)$this->context->employee->id);      if($R602BAA072843820A45861C75C510C77E->id_customer >0)    {     $R4117BD9C2FBBD57A0591E55A5204FD0B = new Customer($R602BAA072843820A45861C75C510C77E->id_customer);     $RC29284A612182CD722FEC7C2FC1074F4 = Tools::getAdminToken('AdminCustomers'.(int)(Tab::getIdFromClassName('AdminCustomers')).(int)$this->context->employee->id);    }         $this->tpl_view_vars = array(     'is_seller' => $this->is_seller,     'the_message' => $R602BAA072843820A45861C75C510C77E,     'customer' => isset($R4117BD9C2FBBD57A0591E55A5204FD0B)? $R4117BD9C2FBBD57A0591E55A5204FD0B : null,     'product' => $RB3F07F8C3658A835940E88288B58F707,     'tokenCustomer' => isset ($RC29284A612182CD722FEC7C2FC1074F4) ? $RC29284A612182CD722FEC7C2FC1074F4 : null,     'tokenProduct' => isset ($R0CC5C52265050028304C711237F130C2) ? $R0CC5C52265050028304C711237F130C2 : null,     'hide_email' => intval(Configuration::get('ASMGER_HIDE_EMAIL')),     'attachments' => $R3C7F4BEFFA401E576A1962D683014AAB,    );      return parent::renderView();   }     public function renderForm()   {    if (!($R602BAA072843820A45861C75C510C77E = $this->loadObject(true)))     return;         $R2581B8900A2BE6416036A5AC0C320291 = new Currency(Configuration::get('PS_CURRENCY_DEFAULT'));      $this->fields_form = array(     'legend' => array(       'title' => $this->l('Message Details')       ),     'input' => array(      array(       'type' => 'text',       'label' => $this->l('Subject'),       'name' => 'subject',       'size' => 33,       'required' => false       ),        array(        'type' => 'date',        'label' => $this->l('Date'),        'name' => 'date_add',        'size' => 33,        'required' => false        ),        array(       'type' => 'product',       'label' => $this->l('Product'),       'name' => 'id_product',       'size' => 33,       'required' => false       ),        array(       'type' => 'text',        'label' => $this->l('From Name'),       'name' => 'from_name',       'size' => 33,       'required' => false       ),        array(       'type' => 'text',       'label' => $this->l('From Email'),       'name' => 'from_email',       'size' => 33,       'required' => false       ),          array(       'type' => 'textarea',       'label' => $this->l('Message'),       'name' => 'message',       'rows' => 10,       'cols' => 100,       'required' => false       ),        array(       'type' => 'attachment',       'label' => $this->l('Attachment 1'),       'name' => 'attpsname1',       'size' => 33,       'required' => false       ),        array(       'type' => 'attachment',       'label' => $this->l('Attachment 2'),       'name' => 'attpsname1',       'size' => 33,       'required' => false       ),        array(       'type' => 'attachment',       'label' => $this->l('Attachment 3'),       'name' => 'attpsname3',       'size' => 33,       'required' => false       ),      )     );      $this->fields_form['submit'] = array(     'title' => $this->l('Save'),     'class' => 'agile-btn agile-btn-default pull-right'    );        $RB3F07F8C3658A835940E88288B58F707 = new Product($R602BAA072843820A45861C75C510C77E->id_product, false, $this->context->cookie->id_lang);    $R0CC5C52265050028304C711237F130C2 = Tools::getAdminToken('AdminProducts'.(int)(Tab::getIdFromClassName('AdminProducts')).(int)$this->context->employee->id);      if($R602BAA072843820A45861C75C510C77E->id_customer >0)    {     $R4117BD9C2FBBD57A0591E55A5204FD0B = new Customer($R602BAA072843820A45861C75C510C77E->id_customer);     $RC29284A612182CD722FEC7C2FC1074F4 = Tools::getAdminToken('AdminCustomers'.(int)(Tab::getIdFromClassName('AdminCustomers')).(int)$this->context->employee->id);    }    else    {     $R4117BD9C2FBBD57A0591E55A5204FD0B = new Customer();     $R4117BD9C2FBBD57A0591E55A5204FD0B->firstname = $R602BAA072843820A45861C75C510C77E->from_name;     $R4117BD9C2FBBD57A0591E55A5204FD0B->email = $R602BAA072843820A45861C75C510C77E->from_email;    }      $this->tpl_form_vars = array(     'customer' => isset($R4117BD9C2FBBD57A0591E55A5204FD0B)? $R4117BD9C2FBBD57A0591E55A5204FD0B : null,     'product' => $RB3F07F8C3658A835940E88288B58F707,     'tokenCustomer' => isset ($RC29284A612182CD722FEC7C2FC1074F4) ? $RC29284A612182CD722FEC7C2FC1074F4 : null,     'tokenProduct' => isset ($R0CC5C52265050028304C711237F130C2) ? $R0CC5C52265050028304C711237F130C2 : null,     'the_message' => $R602BAA072843820A45861C75C510C77E    );       return parent::renderForm();   }      }      