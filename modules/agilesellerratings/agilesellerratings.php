<?php
///-build_id: 2017010307.5027
/// This source file is subject to the Software License Agreement that is bundled with this 
/// package in the file license.txt, or you can get it here
/// http://addons-modules.com/en/content/3-terms-and-conditions-of-use
///
/// @copyright  2009-2016 Addons-Modules.com
///  If you need open code to customize or merge code with othe modules, please contact us.
if (!defined('_PS_VERSION_'))
	exit;

class AgileSellerRatings extends Module
{
	const RATING_TYPE_SELLER = 1;
	const RATING_TYPE_MANUFACTURER = 2;
	const RATING_TYPE_SUPPLIER = 3;

	private	$_html = '';
	
	const DELAY = 1; 
	function __construct()      {    $this->agile_configs = Configuration::getMultiple($this->getConfigKeys());      $this->agile_dependencies = array('agilemultipleseller' => '3.7.0.1', 'agilekernel'=>'1.7.1.0');     $this->agile_newfiles = array();              $this->name = 'agilesellerratings';    $this->isAgileKernelCompatible = true;    $this->tab = 'Administration';    $this->bootstrap = true;         $this->author = 'addons-modules.com';    $this->version = '2.7.0.3';    $this->ps_versions_compliancy = array('min' => '1.7', 'max' => '1.8');    $this->dependencies = array('agilemultipleseller','agilekernel');      parent::__construct();            $this->displayName = $this->l('Agile Seller Ratings');          $this->description = $this->l('Allows users to rate and give feedback on sellers');   }     private function getConfigKeys()  {   return array();  }       function install()      {      if(!Module::isInstalled('agilekernel'))    {     $this->_errors[] = $this->l('You have to install Agile Kernel module before installing this module. The download link of this module should have been included your download email for your order. If you can not find it, please request by email to support@addons-modules.com with your order #.');     return false;    }      if(!$this->AgilePreinstall())return false;              if  (parent::install() == false )    {     $this->_errors[] = $this->l('Install error - call parent::install()');     return false;    }      AgileInstaller::add_field_ifnotexists('agile_rating','response','text','NULL');    AgileInstaller::add_field_ifnotexists('agile_rating','date_upd','datetime','');          $R44B1740495C3DC5BAB56D0F3706FEA4F = intval(Configuration::get('AGILE_MS_PROFILE_ID'));    if(!AgileInstaller::create_tab('Review/Rating','AgileReviewParent','AgileModulesParent', $this->name))return false;    AgileInstaller::init_tab_prmission_for_existing_profiles('AgileReviewParent',1,1,1,1);    AgileInstaller::update_access($R44B1740495C3DC5BAB56D0F3706FEA4F, 'AgileReviewParent',1,0,0,0);      if(!AgileInstaller::create_tab("Seller Ratings", "AdminSellerRatings", 'AgileReviewParent',$this->name))return false;    AgileInstaller::init_tab_prmission_for_existing_profiles('AdminSellerRatings',1,1,1,1);    AgileInstaller::update_access($R44B1740495C3DC5BAB56D0F3706FEA4F, 'AdminSellerRatings',1,0,0,0);              if($this->registerHook('displayCustomerAccount') == false     OR $this->registerHook('displayMyAccountBlock') == false     OR $this->registerHook('displayRightColumnProduct')== false     )return (false);        $this->initCriterions();        Autoload::getInstance()->generateIndex();      return (true);      }     public function uninstall()   {       if(!parent::uninstall())return false;            AgileInstaller::delete_tab("AdminSellerRatings");    AgileInstaller::delete_tab("AgileReviewParent");        return true;   }     public function getContent()   {    $this->_html = '<h2>'.$this->displayName.'</h2>';        $R0E50532F705BA890C56DC90FC3472539 = AgileInstaller::detect_admin_folder($_SERVER['SCRIPT_FILENAME']);    $R5A0E1B3F4DE39462E7CECCA34A34D7E1 = AgileInstaller::install_health_check($this->agile_newfiles, $this->name, $R0E50532F705BA890C56DC90FC3472539);    if(!empty($R5A0E1B3F4DE39462E7CECCA34A34D7E1)) $this->_html .= $R5A0E1B3F4DE39462E7CECCA34A34D7E1;      $this->_checkCriterion();        $this->_html .= AgileInstaller::show_agile_links();      require_once(dirname(__FILE__).'/AgileRatingCriterion.php');    $RF71F9F70BCEFBFFFBDF1B8ADD577AE20 = AgileRatingCriterion::getList($this->context->cookie->id_lang);    $R57AA4613332648D21A28D4A0A082DF60=array();    foreach($RF71F9F70BCEFBFFFBDF1B8ADD577AE20 AS $RBBEAD13A7562B88D638908AF9AB5F8C1)    {     array_push($R57AA4613332648D21A28D4A0A082DF60, array('id' => $RBBEAD13A7562B88D638908AF9AB5F8C1['id_agile_rating_criterion'], 'name' => htmlspecialchars($RBBEAD13A7562B88D638908AF9AB5F8C1['name'], ENT_COMPAT, 'UTF-8')));    }      $RD05A28496998D5D330106BBAE629B948 = array(     'form' => array(      'legend' => array(       'title' => $this->l('Review\'s criterions'),       'image' => $this->_path.'logo.png',      ),      'description' => $this->l('If seller has private categories, you show seller rating on seller private category page. See install.txt for instructions'),      'input' => array(       array(        'type' => 'placeholder',        'label' => $this->l('Review\'s criterion'),        'name' => 'divCriterionForm',        'form_group_class' => "reviewcriterion",        'submit_label' => $this->l('Save'),        'submit_name' => 'submitCriterion',       ),       array(        'type' => 'hidden',        'name' => 'id_agile_rating_criterion',       ),       array(        'type' => 'hidden',        'name' => 'criterion_name',       ),       array(        'type' => 'hidden',        'name' => 'criterion_id_lang',       ),       array(        'type' => 'hidden',        'name' => 'criterion_action',       ),       array(        'type' => 'criterions',        'label' => $this->l('Review\'s criterions'),        'name' => 'criterions',        'values' => $R57AA4613332648D21A28D4A0A082DF60,        'delete_warning_msg' => $this->l('When deleting criterion, all related data will be deleted.  Do you want to proceed?') ,        'title_actions' =>$this->l('Actions'),        'title_Criterion' =>$this->l('Criterion'),        'edit_action' => $this->l('Edit'),        'delete_action' => $this->l('Delete'),       ),      ),     )    );    $R3A1E73211A105E82A8C89F8C8E3C8264 = new HelperForm();    $R3A1E73211A105E82A8C89F8C8E3C8264->show_toolbar = false;    $R3A1E73211A105E82A8C89F8C8E3C8264->table =  'criterion';    $R51C716B9664B3F4E109066C05B9B1A86 = new Language((int)Configuration::get('PS_LANG_DEFAULT'));    $R3A1E73211A105E82A8C89F8C8E3C8264->default_form_language = $R51C716B9664B3F4E109066C05B9B1A86->id;    $R3A1E73211A105E82A8C89F8C8E3C8264->module = $this;    $R3A1E73211A105E82A8C89F8C8E3C8264->allow_employee_form_lang = Configuration::get('PS_BO_ALLOW_EMPLOYEE_FORM_LANG') ? Configuration::get('PS_BO_ALLOW_EMPLOYEE_FORM_LANG') : 0;    $R3A1E73211A105E82A8C89F8C8E3C8264->identifier = 'permission_setting';    $R3A1E73211A105E82A8C89F8C8E3C8264->currentIndex = $this->context->link->getAdminLink('AdminModules', false).'&configure='.$this->name.'&tab_module='.$this->tab.'&module_name='.$this->name;    $R3A1E73211A105E82A8C89F8C8E3C8264->token = Tools::getAdminTokenLite('AdminModules');    $R3A1E73211A105E82A8C89F8C8E3C8264->tpl_vars = array(     'fields_value' => array(     'id_agile_rating_criterion' =>'',     'criterion_name' =>'',       'criterion_id_lang' =>intval($this->context->cookie->id_lang),     'criterion_action' =>''     ),     'languages' => $this->context->controller->getLanguages(),     'id_language' => $this->context->language->id    );      $this->_html .=  $R3A1E73211A105E82A8C89F8C8E3C8264->generateForm(array($RD05A28496998D5D330106BBAE629B948));      $this->_html .=  '              <script  type="text/javascript" >                  thePath = "' . $this->_path . '";              </script>              <script type="text/javascript" src="'.$this->_path.'js/criterion_edit.js"></script>     ';          return $this->_html;   }         private function _checkCriterion()   {    require_once(dirname(__FILE__).'/AgileRatingCriterion.php');      $R9E46D451691DBFF089E74186718109CD = Tools::getValue('criterion_action');    if ($R9E46D451691DBFF089E74186718109CD == 'delete')    {     $R49913C654DA86F0CA106C6A63306284C = Tools::getValue('id_agile_rating_criterion');     AgileRatingCriterion::deleteCriterion($R49913C654DA86F0CA106C6A63306284C);    }    if (Tools::isSubmit('submitCriterion'))    {     $R76F813E5E2ECD893182730D21F1A8608 = intval(Tools::getValue('criterion_id'));              $RBBEAD13A7562B88D638908AF9AB5F8C1 = new AgileRatingCriterion($R76F813E5E2ECD893182730D21F1A8608);     $RE4383934787B83B49DDB150913CF42D2 = Language::getLanguages(true);              foreach($RE4383934787B83B49DDB150913CF42D2 AS $R51C716B9664B3F4E109066C05B9B1A86)              {                  $R9B395079675C6A66FF23EA9C6C4A668E = Tools::getValue('criterion_'. $R51C716B9664B3F4E109066C05B9B1A86['id_lang']);                  if(trim($R9B395079675C6A66FF23EA9C6C4A668E) == '')                  {       $this->_errors[] = $this->l('Criterion name is required for all languages');       break;                  }                   $R50451D4F16D751D8DCB79549C411BCC6 = new AgileRatingCriterion();                  $R50451D4F16D751D8DCB79549C411BCC6->getByName($R9B395079675C6A66FF23EA9C6C4A668E,$R51C716B9664B3F4E109066C05B9B1A86['id_lang']);                  if(Validate::isLoadedObject($R50451D4F16D751D8DCB79549C411BCC6) AND $R50451D4F16D751D8DCB79549C411BCC6->id != $R76F813E5E2ECD893182730D21F1A8608)                  {       $this->_errors[] = $this->l('Same criterion exists') . ' [' . $R9B395079675C6A66FF23EA9C6C4A668E . ']';       break;                  }                  $RBBEAD13A7562B88D638908AF9AB5F8C1->{'name'}[$R51C716B9664B3F4E109066C05B9B1A86['id_lang']] = Tools::getValue('criterion_'. $R51C716B9664B3F4E109066C05B9B1A86['id_lang']);              }     if(empty($this->_errors))              {                  $RBBEAD13A7562B88D638908AF9AB5F8C1->save();      $this->_html .= $this->displayConfirmation($this->l('Settings updated'));           }           else                  $this->displayErrors();                    }   }      public function displayErrors()   {    $R5E535DBA6BC26B2ECEEF3DA589516785 = sizeof($this->_errors);    $this->_html .=  '    <div class="module_error alert alert-danger">     <h3>'.($R5E535DBA6BC26B2ECEEF3DA589516785 > 1 ? $this->l('There are') : $this->l('There is')).' '.$R5E535DBA6BC26B2ECEEF3DA589516785.' '.($R5E535DBA6BC26B2ECEEF3DA589516785 > 1 ? $this->l('errors') : $this->l('error')).'</h3>     <ol>';    foreach ($this->_errors AS $RB5ADDE8D7D7412251F47419FE9BF51A7)     $this->_html .=  '      <li>'.$RB5ADDE8D7D7412251F47419FE9BF51A7.'</li>';      $this->_html .=  '     </ol>    </div>';   }      public function hookDisplayMyAccountBlock($RC2D2567438B1F39DD71F78195B5F3DED)   {    if(!$this->active)return;    return $this->displayMyAccountHook($RC2D2567438B1F39DD71F78195B5F3DED, 'myaccount.tpl');   }       public function hookDisplayCustomerAccount($RC2D2567438B1F39DD71F78195B5F3DED)   {          if(!$this->active)return;    return $this->displayMyAccountHook($RC2D2567438B1F39DD71F78195B5F3DED, 'customeraccount.tpl');   }     private function displayMyAccountHook($RC2D2567438B1F39DD71F78195B5F3DED, $RED0E9620B134E4F8E980DEEC7632685F)   {    require_once(dirname(__FILE__).'/AgileRating.php');        $this->context->smarty->assign(array(     'nb_feedback_waiting' => AgileRating::getFeedbackWaitingCount($this->context->cookie->id_customer),     'feedbackwaitlist_url' => self::get_waitlist_url()     ));    return $this->display(__FILE__, $RED0E9620B134E4F8E980DEEC7632685F);   }      public function hookDisplayRightColumnProduct($RC2D2567438B1F39DD71F78195B5F3DED)   {       if(!$this->active)return;                    require_once(dirname(__FILE__) . '/AgileRating.php');                    $R40095968F29813E02A981F327827F17B = Tools::getValue('id_product');          $R130D64A4AD653C91E0FD80DE8FEADC3A = 'SELECT id_owner FROM `'._DB_PREFIX_.'product_owner` WHERE id_product='. $R40095968F29813E02A981F327827F17B;          $R80E0AA7BCEB7A11A0E981699C49A56A4 = Db::getInstance()->getRow($R130D64A4AD653C91E0FD80DE8FEADC3A);          $RCBC984619B225938552157EAB97522FE = isset($R80E0AA7BCEB7A11A0E981699C49A56A4['id_owner'])?intval($R80E0AA7BCEB7A11A0E981699C49A56A4['id_owner']):0;    return $this->getAverageRating($RCBC984619B225938552157EAB97522FE, self::RATING_TYPE_SELLER);   }      public static function getAverageRating4Category($RF664E51958D748D9CA7C7C2D6C20EC0C)   {    if(intval($RF664E51958D748D9CA7C7C2D6C20EC0C)<=0)return '';    $R1B8AE585FCBE16464BB4673988D498E2 = AgileSellerManager::getObjectOwnerID('category', $RF664E51958D748D9CA7C7C2D6C20EC0C);    if(intval($R1B8AE585FCBE16464BB4673988D498E2)<=0)return '';    $R01787CB5A57D47DC8A648998E4A6512C = new AgileSellerRatings();    return $R01787CB5A57D47DC8A648998E4A6512C->getAverageRating($R1B8AE585FCBE16464BB4673988D498E2,  self::RATING_TYPE_SELLER);   }      public function getAverageRating($RCBC984619B225938552157EAB97522FE, $RDD7B149E44333E3080977498EF4B7560)   {    if(!$this->active)return;    if($RCBC984619B225938552157EAB97522FE<=0)return;        $this->context->smarty->assign($this->getAverageRatingData($RCBC984619B225938552157EAB97522FE, $RDD7B149E44333E3080977498EF4B7560));        return ($this->display(__FILE__, '/hookaverage.tpl'));       }       public function getAverageRating4List($RCBC984619B225938552157EAB97522FE, $RDD7B149E44333E3080977498EF4B7560)   {    if(!$this->active)return;    if($RCBC984619B225938552157EAB97522FE<=0)return;        $this->context->smarty->assign($this->getAverageRatingData($RCBC984619B225938552157EAB97522FE, $RDD7B149E44333E3080977498EF4B7560));        return ($this->display(__FILE__, '/hookaverage_list.tpl'));   }      public function getAverageRatingData($RCBC984619B225938552157EAB97522FE, $RDD7B149E44333E3080977498EF4B7560)   {    $link = new Link();          require_once(dirname(__FILE__) . '/AgileRating.php');            $R172917DC6EAE59BBC4FC473FFA7D0E36 = AgileRating::getAverage($RCBC984619B225938552157EAB97522FE,$RDD7B149E44333E3080977498EF4B7560);          $RC5A47D3963F7D15BCF5CB794E7752F4F = AgileRating::getCount($RCBC984619B225938552157EAB97522FE,$RDD7B149E44333E3080977498EF4B7560);    $R13C0BF275DA2D94E4E27A8E261D3D18D = '';    if(Module::isInstalled('agilesellerproducts') OR Module::isInstalled('agilemultipleshop'))    {     $R13C0BF275DA2D94E4E27A8E261D3D18D = $link->getAgileSellerLink($RCBC984619B225938552157EAB97522FE);    }      $R13C7C6A1B486150BE1DDA0EA6288EFA6 = Tools::getShopDomainSsl(true,true) . __PS_BASE_URI__ . "modules/agilesellerratings/ratinglist.php?id_type=1&id_target=" . $RCBC984619B225938552157EAB97522FE;    if(version_compare(_PS_VERSION_, '1.5', '>='))     $R13C7C6A1B486150BE1DDA0EA6288EFA6 = Context::getContext()->link->getModuleLink('agilesellerratings', 'ratinglist', array('id_type'=>1, 'id_target'=>$RCBC984619B225938552157EAB97522FE), true);              return array(              'id_rating_target' => $RCBC984619B225938552157EAB97522FE              ,'name_rating_target' => self::getTargetName($RCBC984619B225938552157EAB97522FE,$RDD7B149E44333E3080977498EF4B7560)              ,'average_rating_target' => $R172917DC6EAE59BBC4FC473FFA7D0E36              ,'bn_rating_target' => $RC5A47D3963F7D15BCF5CB794E7752F4F              ,'link_target' => $R13C7C6A1B486150BE1DDA0EA6288EFA6              ,'stars_target' => self::getStarsImages($R172917DC6EAE59BBC4FC473FFA7D0E36)     ,'link2sellerpage' => $R13C0BF275DA2D94E4E27A8E261D3D18D              ,'average_percentage' => $R172917DC6EAE59BBC4FC473FFA7D0E36 * 20          );                 }      public static function getStarsImages($RA17865CA91808C9E7828ED9390630BA8)   {       $R2366ABDEBCB20EDA126A1FDC1E27009C = '';          for($R5B92E56774920499F4ADDD0EC782C83E=1;$R5B92E56774920499F4ADDD0EC782C83E<=5;$R5B92E56774920499F4ADDD0EC782C83E++)          {              if($RA17865CA91808C9E7828ED9390630BA8>$R5B92E56774920499F4ADDD0EC782C83E)              {                  $R2366ABDEBCB20EDA126A1FDC1E27009C = $R2366ABDEBCB20EDA126A1FDC1E27009C = $R2366ABDEBCB20EDA126A1FDC1E27009C . '<img src="' . _MODULE_DIR_ . '/agilesellerratings/img/star4.png" />';              }              else              {                  $R88F05A0448CCB925AE3145EB4BCBBA44 = ($RA17865CA91808C9E7828ED9390630BA8 + 1 - $R5B92E56774920499F4ADDD0EC782C83E)*100;                  if($R88F05A0448CCB925AE3145EB4BCBBA44 <10)                      $R2366ABDEBCB20EDA126A1FDC1E27009C = $R2366ABDEBCB20EDA126A1FDC1E27009C . '<img src="' . _MODULE_DIR_ . '/agilesellerratings/img/star0.png" />';                  elseif($R88F05A0448CCB925AE3145EB4BCBBA44 <35)                      $R2366ABDEBCB20EDA126A1FDC1E27009C = $R2366ABDEBCB20EDA126A1FDC1E27009C . '<img src="' . _MODULE_DIR_ . '/agilesellerratings/img/star1.png" />';                  elseif($R88F05A0448CCB925AE3145EB4BCBBA44 <65)                      $R2366ABDEBCB20EDA126A1FDC1E27009C = $R2366ABDEBCB20EDA126A1FDC1E27009C . '<img src="' . _MODULE_DIR_ . '/agilesellerratings/img/star2.png" />';                  elseif($R88F05A0448CCB925AE3145EB4BCBBA44 <85)                      $R2366ABDEBCB20EDA126A1FDC1E27009C = $R2366ABDEBCB20EDA126A1FDC1E27009C . '<img src="' . _MODULE_DIR_ . '/agilesellerratings/img/star3.png" />';                  else                      $R2366ABDEBCB20EDA126A1FDC1E27009C = $R2366ABDEBCB20EDA126A1FDC1E27009C . '<img src="' . _MODULE_DIR_ . '/agilesellerratings/img/star4.png" />';              }          }    return '<span style="display: inline-block">' .  $R2366ABDEBCB20EDA126A1FDC1E27009C . '</span>';   }      public static function getTargetName($RCBC984619B225938552157EAB97522FE,$R380E3037993CB742B735A382A9C483E7)   {       if($R380E3037993CB742B735A382A9C483E7 == self::RATING_TYPE_SELLER)       {     include_once(_PS_ROOT_DIR_  . "/modules/agilemultipleseller/SellerInfo.php");     $R3F76C20596A009928F756B651F405812 = new SellerInfo(SellerInfo::getIdBSellerId($RCBC984619B225938552157EAB97522FE), Context::getContext()->cookie->id_lang);     if(Validate::isLoadedObject($R3F76C20596A009928F756B651F405812) AND !empty($R3F76C20596A009928F756B651F405812->company))      return $R3F76C20596A009928F756B651F405812->company;          $R17AC9BFA1ABB066C772CEAE0B3CD86E9 = new Employee($RCBC984619B225938552157EAB97522FE);           if(!Validate::isLoadedObject($R17AC9BFA1ABB066C772CEAE0B3CD86E9))return '';     return $R17AC9BFA1ABB066C772CEAE0B3CD86E9->firstname . ' ' . $R17AC9BFA1ABB066C772CEAE0B3CD86E9->lastname;       }   }      public static function formatName($R746CC4EB7DECD1DE03EA8D60987F32E2, $R215D3FF6E50A425648E000EA77342A31)   {          return $R746CC4EB7DECD1DE03EA8D60987F32E2 . ' ' . strtoupper(substr($R215D3FF6E50A425648E000EA77342A31,0,1)) . '.';   }         private function initCriterions()   {    require_once(dirname(__FILE__).'/AgileRatingCriterion.php');          $RF71F9F70BCEFBFFFBDF1B8ADD577AE20 = AgileRatingCriterion::getList();          if(isset($RF71F9F70BCEFBFFFBDF1B8ADD577AE20) AND !empty($RF71F9F70BCEFBFFFBDF1B8ADD577AE20))return;              $R534BDADDF4709161A0B90BA3177FFD4C = array('Shipping','Service','Communication');          foreach($R534BDADDF4709161A0B90BA3177FFD4C as $R9B395079675C6A66FF23EA9C6C4A668E)          {              $RBBEAD13A7562B88D638908AF9AB5F8C1 = new AgileRatingCriterion();        $RE4383934787B83B49DDB150913CF42D2 = Language::getLanguages(true);              foreach($RE4383934787B83B49DDB150913CF42D2 AS $R51C716B9664B3F4E109066C05B9B1A86)              {                  $RBBEAD13A7562B88D638908AF9AB5F8C1->{'name'}[$R51C716B9664B3F4E109066C05B9B1A86['id_lang']] = $R9B395079675C6A66FF23EA9C6C4A668E;              }              $RBBEAD13A7562B88D638908AF9AB5F8C1->save();       }   }      public static function get_waitlist_url()   {    if(version_compare(_PS_VERSION_, '1.5', '>='))     return Context::getContext()->link->getModuleLink('agilesellerratings', 'feedbackwaitlist', array(), true);      return Tools::getShopDomainSsl(true,true) . __PS_BASE_URI__ . "modules/feedbackwaitlist/feedbackwaitlist.php";   }       public static function procss_feedback()   {    $RB10E8575D7A5B4C417D9DCF8D6BC17BE = Context::getContext();        $RF71F9F70BCEFBFFFBDF1B8ADD577AE20 = AgileRatingCriterion::getList($RB10E8575D7A5B4C417D9DCF8D6BC17BE->cookie->id_lang);          $RFF073106DF53C7C31BC2E1F5598ABC67 = 0;          foreach($RF71F9F70BCEFBFFFBDF1B8ADD577AE20 AS $RBBEAD13A7562B88D638908AF9AB5F8C1)          {              $R6CD996866E2BBF02D20BE7CCDCB9D7B9 = intval($RBBEAD13A7562B88D638908AF9AB5F8C1['id_agile_rating_criterion']);              $RFF073106DF53C7C31BC2E1F5598ABC67 = $RFF073106DF53C7C31BC2E1F5598ABC67 + intval($_POST[$R6CD996866E2BBF02D20BE7CCDCB9D7B9 . '_rating_grade']);          }              $R0AF750EE2CEFDB488675D9F23229CD30 = $RFF073106DF53C7C31BC2E1F5598ABC67 / count($RF71F9F70BCEFBFFFBDF1B8ADD577AE20);    $R4117BD9C2FBBD57A0591E55A5204FD0B = new Customer($RB10E8575D7A5B4C417D9DCF8D6BC17BE->cookie->id_customer);          $R1DDE6D99BCE3393BDC2E8FB7D0BCD99A = new AgileRating();          $R1DDE6D99BCE3393BDC2E8FB7D0BCD99A->id = 0;          $R1DDE6D99BCE3393BDC2E8FB7D0BCD99A->id_order = intval(Tools::getValue('rating_id_order'));    $R1DDE6D99BCE3393BDC2E8FB7D0BCD99A->id_customer = $RB10E8575D7A5B4C417D9DCF8D6BC17BE->cookie->id_customer;          $R1DDE6D99BCE3393BDC2E8FB7D0BCD99A->customer = AgileSellerRatings::formatName($R4117BD9C2FBBD57A0591E55A5204FD0B->firstname,$R4117BD9C2FBBD57A0591E55A5204FD0B->lastname);          $R1DDE6D99BCE3393BDC2E8FB7D0BCD99A->id_target = intval(Tools::getValue('rating_id_owner'));;    $R1DDE6D99BCE3393BDC2E8FB7D0BCD99A->id_lang = $RB10E8575D7A5B4C417D9DCF8D6BC17BE->cookie->id_lang;          $R1DDE6D99BCE3393BDC2E8FB7D0BCD99A->id_type = AgileSellerRatings::RATING_TYPE_SELLER;          $R1DDE6D99BCE3393BDC2E8FB7D0BCD99A->content = strip_tags(Tools::getValue('content'));          $R1DDE6D99BCE3393BDC2E8FB7D0BCD99A->ip_address = $_SERVER['REMOTE_ADDR'];          $R1DDE6D99BCE3393BDC2E8FB7D0BCD99A->grade = $R0AF750EE2CEFDB488675D9F23229CD30;          $R1DDE6D99BCE3393BDC2E8FB7D0BCD99A->save();            foreach($RF71F9F70BCEFBFFFBDF1B8ADD577AE20 AS $RBBEAD13A7562B88D638908AF9AB5F8C1)          {              $R6CD996866E2BBF02D20BE7CCDCB9D7B9 = intval($RBBEAD13A7562B88D638908AF9AB5F8C1['id_agile_rating_criterion']);              AgileRating::addCriterionRatingGrade($R1DDE6D99BCE3393BDC2E8FB7D0BCD99A->id, intval($RBBEAD13A7562B88D638908AF9AB5F8C1['id_agile_rating_criterion']),intval($_POST[$R6CD996866E2BBF02D20BE7CCDCB9D7B9 . '_rating_grade']));          }   }       public function process_ratinglist($RBBD82F183416F7FB8A2574330560E7B4)   {    $RCBC984619B225938552157EAB97522FE = intval(Tools::getValue('id_target'));    $R380E3037993CB742B735A382A9C483E7 = intval(Tools::getValue('id_type'));    $RA6270D627FA63966EDB574844BD4F14A = AgileRating::getCount($RCBC984619B225938552157EAB97522FE,$R380E3037993CB742B735A382A9C483E7);      $R4E16FD5F4E8D069DB1B22C04D441E579 = $RBBD82F183416F7FB8A2574330560E7B4->p;    $R33D4338BF9A385708FD0990A3D0BC999 = $RBBD82F183416F7FB8A2574330560E7B4->n;      $R1D36552DD54944BA8B52BAA750AEC324 = AgileRating::getList($RCBC984619B225938552157EAB97522FE,$R380E3037993CB742B735A382A9C483E7,$R4E16FD5F4E8D069DB1B22C04D441E579,$R33D4338BF9A385708FD0990A3D0BC999);    $R451E463C144B3F16EBFFC8A33A5377C7 = AgileSellerRatings::getTargetName($RCBC984619B225938552157EAB97522FE,$R380E3037993CB742B735A382A9C483E7);      for($R5B92E56774920499F4ADDD0EC782C83E=0;$R5B92E56774920499F4ADDD0EC782C83E<count($R1D36552DD54944BA8B52BAA750AEC324);$R5B92E56774920499F4ADDD0EC782C83E++)    {     $R1D36552DD54944BA8B52BAA750AEC324[$R5B92E56774920499F4ADDD0EC782C83E]['stars'] = AgileSellerRatings::getStarsImages($R1D36552DD54944BA8B52BAA750AEC324[$R5B92E56774920499F4ADDD0EC782C83E]['grade']);    }       $this->context->smarty->assign(array(      'agile_ratings' => $R1D36552DD54944BA8B52BAA750AEC324      ,'agile_ratings_nb' => $RA6270D627FA63966EDB574844BD4F14A      ,'agile_target_name' => $R451E463C144B3F16EBFFC8A33A5377C7      ));      $RF71F9F70BCEFBFFFBDF1B8ADD577AE20 = AgileRatingCriterion::getList($this->context->cookie->id_lang);    $RB8BAF21E196B0AC2674B94DC3AABDE58 =   AgileRating::getAverages($RCBC984619B225938552157EAB97522FE,$R380E3037993CB742B735A382A9C483E7);        $R0A8C094CA814F06EB39FB786B3D28C61 = 0;    $R15BD36C48AA093BD22B88E99F5C8EB98= array();    foreach($RB8BAF21E196B0AC2674B94DC3AABDE58 AS $RF413F06AEBBCEF5E1C8B1019DEE6FE6B=>$R244F38266C59587D696AEC08A771B803)    {     $R15BD36C48AA093BD22B88E99F5C8EB98[$RF413F06AEBBCEF5E1C8B1019DEE6FE6B] = AgileSellerRatings::getStarsImages($R244F38266C59587D696AEC08A771B803);     $R0A8C094CA814F06EB39FB786B3D28C61 += floatval($R244F38266C59587D696AEC08A771B803);    }    $R0A8C094CA814F06EB39FB786B3D28C61 = round(count($RB8BAF21E196B0AC2674B94DC3AABDE58) ? ($R0A8C094CA814F06EB39FB786B3D28C61 / count($RB8BAF21E196B0AC2674B94DC3AABDE58)) : 0,1);      $this->context->smarty->assign(array(     'criterions' => $RF71F9F70BCEFBFFFBDF1B8ADD577AE20     ,'averages' => $RB8BAF21E196B0AC2674B94DC3AABDE58     ,'averagestars' => $R15BD36C48AA093BD22B88E99F5C8EB98     ,'averageTotal' => $R0A8C094CA814F06EB39FB786B3D28C61     ,'agilesellerrating_tpl' => _PS_ROOT_DIR_ .  "/modules/agilesellerratings/"          ));   }      public function assignSellerRatingForList($RC11CBBF9A790DD79AF501C6F51DBB310, $R4BD95114037B7B035CC5B10BBEB576A9 = true)   {    for($R5B92E56774920499F4ADDD0EC782C83E=0;$R5B92E56774920499F4ADDD0EC782C83E<count($RC11CBBF9A790DD79AF501C6F51DBB310); $R5B92E56774920499F4ADDD0EC782C83E++)    {     if($R4BD95114037B7B035CC5B10BBEB576A9)     {      $RC11CBBF9A790DD79AF501C6F51DBB310[$R5B92E56774920499F4ADDD0EC782C83E]['seller_rattings'] = $this->getAverageRating4List($RC11CBBF9A790DD79AF501C6F51DBB310[$R5B92E56774920499F4ADDD0EC782C83E]['id_seller'], AgileSellerRatings::RATING_TYPE_SELLER);     }     else     {      $RC11CBBF9A790DD79AF501C6F51DBB310[$R5B92E56774920499F4ADDD0EC782C83E]['seller_rattings'] = $this->getAverageRatingData($RC11CBBF9A790DD79AF501C6F51DBB310[$R5B92E56774920499F4ADDD0EC782C83E]['id_seller'], AgileSellerRatings::RATING_TYPE_SELLER);     }    }        return $RC11CBBF9A790DD79AF501C6F51DBB310;   }  }  